<!DOCTYPE html>
<html lang="zh-Hant" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拓元 API 監控儀表板</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- 引入 Inter 字體 -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        body {
            font-family: "Inter", "PingFang TC", "Microsoft JhengHei", sans-serif;
        }
        .chart-container {
            height: 300px;
        }
    </style>
</head>
<body class="h-full text-white p-6 md:p-10">
    <div class="max-w-7xl mx-auto">
        <!-- 頁首 -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white">拓元 API 監控儀表板</h1>
                <p class="text-sm text-gray-400">tixCraft API Dashboard - 實時監控系統健康度</p>
            </div>
            <div>
                <button id="toggle-sale-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                    模擬搶票開始
                </button>
            </div>
        </header>

        <!-- 核心指標卡片 -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
            <!-- 總流量 (RPS) -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-gray-400 text-sm font-medium">總流量 (RPS)</h2>
                <div class="text-3xl font-bold text-white" id="total-rps">1,205</div>
                <div class="text-sm" id="rps-change-rate"><span class="text-green-400">▲ 5.2%</span> (1 分鐘)</div>
            </div>
            <!-- p95 延遲 -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-gray-400 text-sm font-medium">p95 延遲</h2>
                <div class="text-3xl font-bold text-white" id="p95-latency">120 ms</div>
                <div class="text-sm" id="latency-change-rate"><span class="text-green-400">▼ 1.5%</span> (1 分鐘)</div>
            </div>
            <!-- 5xx 錯誤率 -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-gray-400 text-sm font-medium">5xx 錯誤率</h2>
                <div class="text-3xl font-bold text-white" id="5xx-errors">0.01%</div>
                <div class="text-sm" id="5xx-change-rate"><span class="text-gray-400">-</span></div>
            </div>
            <!-- 資料庫連接 -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-gray-400 text-sm font-medium">資料庫連接池</h2>
                <div class="text-3xl font-bold text-white" id="db-connections">15%</div>
                <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                    <div id="db-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 15%"></div>
                </div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6">
            <!-- 流量圖表 -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold mb-4">即時流量 (RPS)</h2>
                <div class="chart-container">
                    <canvas id="rps-chart"></canvas>
                </div>
            </div>
            
            <!-- 延遲圖表 -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold mb-4">API 延遲 (p99 / p95)</h2>
                <div class="chart-container">
                    <canvas id="latency-chart"></canvas>
                </div>
            </div>

            <!-- 錯誤分佈 -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold mb-4">錯誤狀態碼分佈</h2>
                <div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;">
                    <canvas id="error-chart"></canvas>
                </div>
            </div>

            <!-- 隊列長度 -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold mb-4">訂單隊列 (Queue Length)</h2>
                <div class="chart-container">
                    <canvas id="queue-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- API 端點監控 -->
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-4">關鍵 API 端點 (Endpoints)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">狀態</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Endpoint</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">RPS</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">p99 延遲</th>
                            <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">5xx 錯誤</th>
                        </tr>
                    </thead>
                    <tbody class="bg-gray-800 divide-y divide-gray-700" id="api-table-body">
                        <!-- 數據將由 JS 動態插入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CHART_MAX_DATA_POINTS = 30;
            let isOnSaleMode = false;
            let chartUpdateInterval;

            // 核心指標 DOM
            const totalRpsEl = document.getElementById('total-rps');
            const rpsChangeRateEl = document.getElementById('rps-change-rate');
            const p95LatencyEl = document.getElementById('p95-latency');
            const latencyChangeRateEl = document.getElementById('latency-change-rate');
            const error5xxEl = document.getElementById('5xx-errors');
            const error5xxChangeEl = document.getElementById('5xx-change-rate');
            const dbConnectionsEl = document.getElementById('db-connections');
            const dbBarEl = document.getElementById('db-bar');
            const apiTableBodyEl = document.getElementById('api-table-body');
            const toggleSaleBtn = document.getElementById('toggle-sale-btn');

            // 模擬的 API 端點數據
            let apiEndpoints = {
                'POST /api/orders': { rps: 30, latency: 250, errors: 0.01 },
                'GET /api/events/{id}': { rps: 500, latency: 80, errors: 0.0 },
                'GET /api/events/{id}/seats': { rps: 400, latency: 150, errors: 0.0 },
                'POST /api/login': { rps: 100, latency: 120, errors: 0.02 },
                'POST /api/refresh_token': { rps: 175, latency: 50, errors: 0.0 },
            };

            // 輔助函數
            const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const randFloat = (min, max) => (Math.random() * (max - min) + min);
            
            const formatChange = (oldVal, newVal) => {
                if (oldVal === 0) return '<span class="text-gray-400">-</span>';
                const change = ((newVal - oldVal) / oldVal) * 100;
                const color = change > 0 ? 'text-red-400' : 'text-green-400';
                const icon = change > 0 ? '▲' : '▼';
                return `<span class="${color}">${icon} ${Math.abs(change).toFixed(1)}%</span> (1 分鐘)`;
            };
            
            const getStatusIndicator = (latency, error) => {
                if (error > 1) return '<span class="inline-block h-3 w-3 rounded-full bg-red-500" title="嚴重"></span>';
                if (latency > 1500) return '<span class="inline-block h-3 w-3 rounded-full bg-yellow-500" title="警告"></span>';
                return '<span class="inline-block h-3 w-3 rounded-full bg-green-500" title="正常"></span>';
            };

            // 圖表配置
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'second' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { color: 'rgb(209, 213, 219)' },
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { color: 'rgb(209, 213, 219)' },
                    }
                },
                plugins: {
                    legend: { labels: { color: 'rgb(209, 213, 219)' } }
                },
                animation: false,
            };

            // 建立圖表
            const rpsChart = new Chart(document.getElementById('rps-chart').getContext('2d'), {
                type: 'line',
                data: { datasets: [{ label: '總 RPS', data: [], borderColor: 'rgb(59, 130, 246)', tension: 0.1, pointRadius: 0 }] },
                options: chartOptions,
            });

            const latencyChart = new Chart(document.getElementById('latency-chart').getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'p99 (ms)', data: [], borderColor: 'rgb(234, 179, 8)', tension: 0.1, pointRadius: 0 },
                        { label: 'p95 (ms)', data: [], borderColor: 'rgb(34, 197, 94)', tension: 0.1, pointRadius: 0 },
                    ]
                },
                options: chartOptions,
            });

            const errorChart = new Chart(document.getElementById('error-chart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['2xx (成功)', '4xx (客戶端)', '5xx (伺服器)'],
                    datasets: [{
                        data: [98, 1.5, 0.5],
                        backgroundColor: ['rgb(34, 197, 94)', 'rgb(234, 179, 8)', 'rgb(239, 68, 68)'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'rgb(209, 213, 219)' } } } }
            });

            const queueChart = new Chart(document.getElementById('queue-chart').getContext('2d'), {
                type: 'line',
                data: { datasets: [{ label: '隊列中訂單數', data: [], borderColor: 'rgb(168, 85, 247)', tension: 0.1, pointRadius: 0, fill: true, backgroundColor: 'rgba(168, 85, 247, 0.2)' }] },
                options: chartOptions,
            });
            
            // 數據更新函數
            const updateData = () => {
                let totalRps = 0;
                let p99 = 0;
                let p95 = 0;
                let total5xx = 0;
                let total4xx = 0;
                let total2xx = 0;
                let dbConn = 0;
                let queueLength = 0;

                const now = Date.now();
                
                // 模擬數據變化
                if (isOnSaleMode) {
                    // 搶票模式：流量暴增、延遲上升、429 (client error) 增加
                    apiEndpoints['POST /api/orders'].rps = rand(15000, 25000);
                    apiEndpoints['POST /api/orders'].latency = rand(800, 3000);
                    apiEndpoints['POST /api/orders'].errors = randFloat(0.5, 2.5); // 5xx 錯誤可能上升
                    
                    apiEndpoints['GET /api/events/{id}/seats'].rps = rand(50000, 80000);
                    apiEndpoints['GET /api/events/{id}/seats'].latency = rand(300, 1000);
                    
                    p99 = rand(1000, 3500);
                    p95 = rand(500, 1500);
                    total4xx = rand(20000, 50000); // 大量的 429
                    total5xx = rand(50, 500);
                    dbConn = rand(70, 95);
                    queueLength = rand(5000, 20000);

                } else {
                    // 正常模式
                    apiEndpoints['POST /api/orders'].rps = rand(20, 40);
                    apiEndpoints['POST /api/orders'].latency = rand(200, 300);
                    apiEndpoints['POST /api/orders'].errors = randFloat(0.01, 0.05);

                    apiEndpoints['GET /api/events/{id}/seats'].rps = rand(350, 450);
                    apiEndpoints['GET /api/events/{id}/seats'].latency = rand(130, 170);
                    
                    p99 = rand(150, 250);
                    p95 = rand(100, 140);
                    total4xx = rand(10, 50);
                    total5xx = rand(0, 5);
                    dbConn = rand(10, 20);
                    queueLength = rand(0, 10);
                }

                // 計算總數
                Object.values(apiEndpoints).forEach(api => { totalRps += api.rps; });
                totalRps += rand(500, 1000); // 其他 API
                total2xx = totalRps - total4xx - total5xx;

                // 更新核心指標卡片
                const oldRps = parseInt(totalRpsEl.textContent.replace(/,/g, ''));
                totalRpsEl.textContent = totalRps.toLocaleString();
                rpsChangeRateEl.innerHTML = formatChange(oldRps, totalRps);

                const oldLatency = parseInt(p95LatencyEl.textContent);
                p95LatencyEl.textContent = `${p95} ms`;
                latencyChangeRateEl.innerHTML = formatChange(oldLatency, p95);
                
                const errorRate = (total5xx / totalRps * 100).toFixed(2);
                const oldErrorRate = parseFloat(error5xxEl.textContent);
                error5xxEl.textContent = `${errorRate}%`;
                error5xxChangeEl.innerHTML = formatChange(oldErrorRate, errorRate);
                if (errorRate > 1) error5xxEl.classList.add('text-red-500');
                else error5xxEl.classList.remove('text-red-500');

                dbConnectionsEl.textContent = `${dbConn}%`;
                dbBarEl.style.width = `${dbConn}%`;
                if (dbConn > 85) dbBarEl.classList.add('bg-red-500');
                else dbBarEl.classList.remove('bg-red-500');

                // 更新圖表
                updateChart(rpsChart, now, totalRps);
                updateChart(latencyChart, now, [p99, p95]);
                updateChart(queueChart, now, queueLength);
                
                errorChart.data.datasets[0].data = [total2xx, total4xx, total5xx];
                errorChart.update();

                // 更新 API 端點表格
                apiTableBodyEl.innerHTML = '';
                for (const [name, data] of Object.entries(apiEndpoints)) {
                    const status = getStatusIndicator(data.latency, data.errors);
                    const row = `
                        <tr class="hover:bg-gray-700">
                            <td class="py-3 px-4 text-center">${status}</td>
                            <td class="py-3 px-4 font-mono text-sm">${name}</td>
                            <td class="py-3 px-4">${data.rps.toLocaleString()}</td>
                            <td class="py-3 px-4">${data.latency} ms</td>
                            <td class="py-3 px-4 ${data.errors > 1 ? 'text-red-400' : ''}">${data.errors.toFixed(2)}%</td>
                        </tr>
                    `;
                    apiTableBodyEl.innerHTML += row;
                }
            };

            // 圖表更新輔助函數
            function updateChart(chart, time, data) {
                if (Array.isArray(data)) {
                    data.forEach((val, index) => {
                        chart.data.datasets[index].data.push({ x: time, y: val });
                        if (chart.data.datasets[index].data.length > CHART_MAX_DATA_POINTS) {
                            chart.data.datasets[index].data.shift();
                        }
                    });
                } else {
                    chart.data.datasets[0].data.push({ x: time, y: data });
                    if (chart.data.datasets[0].data.length > CHART_MAX_DATA_POINTS) {
                        chart.data.datasets[0].data.shift();
                    }
                }
                chart.update();
            }
            
            // 模擬按鈕事件
            toggleSaleBtn.addEventListener('click', () => {
                isOnSaleMode = !isOnSaleMode;
                if (isOnSaleMode) {
                    toggleSaleBtn.textContent = '搶票進行中... (點此結束)';
                    toggleSaleBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    toggleSaleBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'animate-pulse');
                    // 加快更新頻率
                    clearInterval(chartUpdateInterval);
                    chartUpdateInterval = setInterval(updateData, 1000); // 搶票時 1 秒更新一次
                } else {
                    toggleSaleBtn.textContent = '模擬搶票開始';
                    toggleSaleBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    toggleSaleBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'animate-pulse');
                    // 恢復正常更新頻率
                    clearInterval(chartUpdateInterval);
                    chartUpdateInterval = setInterval(updateData, 3000); // 正常 3 秒更新一次
                }
                updateData(); // 立即更新一次
            });

            // 初始載入並設定定時更新
            updateData();
            chartUpdateInterval = setInterval(updateData, 3000);
        });
    </script>
</body>
</html>
